# Stats Page Title & Theme Fix

**Date:** November 3, 2025  
**Issues Fixed:**
1. Page title showing "Next.js" instead of proper title
2. Theme breaking (going to light mode) when opening stats page

---

## Root Cause

The stats page had its own `layout.tsx` file that created a separate `<html>` and `<body>` structure:

```tsx
// glasscode/frontend/src/app/stats/layout.tsx (DELETED)
export const metadata = {
  title: 'Next.js',  // ❌ Wrong title
  description: 'Generated by Next.js',
}

export default function RootLayout({ children }) {
  return (
    <html lang="en">  {/* ❌ New html tag breaks theme */}
      <body>{children}</body>  {/* ❌ New body tag bypasses theme providers */}
    </html>
  )
}
```

### Why This Broke the Theme

1. **Duplicate HTML Structure**: The stats layout created a new `<html>` and `<body>`, completely bypassing the root layout
2. **Missing Theme Providers**: The root layout wraps content in `DarkModeProvider` and sets theme attributes on the `<html>` element
3. **No Theme Script**: The root layout includes an inline script that applies the theme before React hydration
4. **Cookie-Based SSR Theme**: The root layout reads the `gc-theme` cookie to set the initial theme server-side

When navigating to `/stats`, Next.js used the stats-specific layout instead of nesting within the root layout, causing:
- Loss of theme context
- No dark mode class on `<html>`
- No `data-theme` attribute
- Reset to default light mode

---

## Fix Applied

### 1. Deleted Problematic Layout
**File Deleted:** `glasscode/frontend/src/app/stats/layout.tsx`

This ensures the stats page inherits from the root layout and maintains all theme functionality.

### 2. Added Dynamic Title
**File Modified:** `glasscode/frontend/src/app/stats/page.tsx`

Added `useEffect` to set the document title dynamically:

```tsx
import { useEffect } from 'react';

export default function StatsPage() {
  const stats = useAppStats();

  // Set document title dynamically since this is a client component
  useEffect(() => {
    document.title = 'GlassStats - Platform Statistics | GlassCode Academy';
  }, []);

  // ... rest of component
}
```

**Why This Approach:**
- The page is a client component (`'use client'`)
- Next.js metadata export doesn't work in client components
- `useEffect` runs after component mounts and sets the title
- This is a standard pattern for client-side title updates

---

## How Theme System Works

### Root Layout Theme Implementation

The root layout (`src/app/layout.tsx`) implements a sophisticated theme system:

1. **Server-Side Theme Detection**
   ```tsx
   const cookieStore = await cookies();
   const cookieTheme = cookieStore.get('gc-theme')?.value;
   const initialTheme = cookieTheme === 'dark' || cookieTheme === 'light' ? cookieTheme : 'light';
   ```

2. **Initial HTML Attributes**
   ```tsx
   <html 
     lang="en" 
     suppressHydrationWarning 
     data-theme={initialTheme} 
     className={htmlClassName} 
     style={{ colorScheme }}
   >
   ```

3. **Pre-Hydration Script**
   - Reads from: cookie > localStorage > system preference
   - Applies theme before React loads
   - Prevents flash of wrong theme (FOUT)
   - Enables theme toggle to work before JavaScript loads

4. **Theme Providers**
   ```tsx
   <DarkModeProvider>
     {/* All app content */}
   </DarkModeProvider>
   ```

5. **Theme Persistence**
   - Saves to localStorage: `theme` key
   - Saves to cookie: `gc-theme` cookie
   - Supports: `light`, `dark`, `system` modes

### Page-Specific Layouts Break This

When a page has its own layout with `<html>` and `<body>`:
- ❌ New document structure created
- ❌ Root layout's `<html>` attributes lost
- ❌ Theme providers not wrapped
- ❌ Pre-hydration script not executed
- ❌ Theme context unavailable

---

## Verification

### Before Fix
- ✅ Navigate to stats page
- ❌ Title: "Next.js"
- ❌ Theme: Resets to light mode (even if you were in dark mode)
- ❌ Dark mode toggle doesn't work properly

### After Fix
- ✅ Navigate to stats page
- ✅ Title: "GlassStats - Platform Statistics | GlassCode Academy"
- ✅ Theme: Preserved from previous page
- ✅ Dark mode toggle works correctly
- ✅ No flash of wrong theme

---

## Files Modified

### Deleted
- `glasscode/frontend/src/app/stats/layout.tsx`

### Modified
- `glasscode/frontend/src/app/stats/page.tsx`
  - Added `useEffect` import
  - Added dynamic title setter

---

## Best Practices

### ✅ DO: Use Root Layout for Consistent Theme
- Let pages inherit from root layout
- Use metadata exports in server components
- Use `useEffect` for dynamic titles in client components

### ❌ DON'T: Create Page-Specific Layouts with HTML/Body
- Don't create new `<html>` or `<body>` tags
- Don't bypass theme providers
- Don't duplicate layout structure

### Pattern for Client Component Titles
```tsx
'use client';
import { useEffect } from 'react';

export default function MyPage() {
  useEffect(() => {
    document.title = 'My Page Title | GlassCode Academy';
  }, []);
  
  // Component content
}
```

### Pattern for Server Component Titles
```tsx
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'My Page Title | GlassCode Academy',
  description: 'Page description',
};

export default function MyPage() {
  // Component content (no 'use client')
}
```

---

## Related Issues Prevented

This fix also prevents:
- ✅ Loss of auth context on stats page
- ✅ Loss of Apollo client context
- ✅ Broken accessibility features
- ✅ Animated background not rendering
- ✅ Header/footer not appearing
- ✅ Missing floating dark mode toggle

All of these features are provided by the root layout and would be lost with a page-specific layout.

---

## Summary

**Problem:** Stats page had a duplicate layout creating new HTML structure, breaking theme system.

**Solution:** Deleted the page-specific layout to inherit from root layout, added dynamic title with useEffect.

**Result:** Theme persists correctly across navigation, proper page title shows, all root layout features maintained.

---

## TypeScript Errors Note

The current TypeScript errors in the file are due to missing `node_modules`:
```
Cannot find module 'next/link'
Cannot find module '@heroicons/react/24/outline'
```

These will be resolved by running:
```bash
cd glasscode/frontend
npm install
```

The code changes are correct and will work once dependencies are installed.

